
{# ============================================================= #}
{# FILE: templates/base.html                                         #}
{# Bootstrap 5 RTL, واجهة عربية حديثة، كتل قابلة للامتداد           #}
{# Blocks: title, extra_css, header, content, extra_js, footer       #}
{# ============================================================= #}
{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}لوحة تسيير مكتب المحاماة{% endblock %}</title>
    <!-- Bootstrap 5 RTL -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.rtl.min.css"
      rel="stylesheet" >
      <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- خط عربي مناسب -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<!-- Thème Bootstrap 5 (optionnel pour un meilleur rendu) -->
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

      <style>
      body { font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; }
      .navbar-brand img { height: 36px; }
      .brand-subtitle { font-size: .8rem; opacity:.75; }
      .app-shell { min-height: 100vh; display: grid; grid-template-rows: auto 1fr auto; }
      .app-footer { background: #0f172a; color: #fff; }
      .footer-link { color: #cbd5e1; text-decoration: none; }
      .footer-link:hover { color: #fff; }
      .page-header { display:flex; align-items:center; justify-content:space-between; gap:1rem; }
      .page-header .breadcrumb { --bs-breadcrumb-divider: '›'; }
      .card-hover:hover { transform: translateY(-2px); box-shadow: 0 0.5rem 1rem rgba(0,0,0,.08); }
    .select2-container--bootstrap-5 .select2-selection {
  border-radius: 0.75rem;
  min-height: calc(2.25rem + 2px);
  text-align: right;
}
.select2-selection__choice__remove {
  float: left; /* place la croix à gauche dans le mode RTL */
}

/* style.css */
.select2-container--bootstrap-5 .select2-selection__choice {
  padding-right: .75rem;
}
.select2-container--bootstrap-5 .select2-selection__choice__remove {
  margin-left: .5rem; /* espace pour RTL */
  font-size: 1rem;
}
      </style>
    {% block extra_css %}{% endblock %}
  </head>
  <body class="bg-light">
    <div class="app-shell">
      {% block header %}
      <nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm">
        <div class="container-fluid">
          <a class="navbar-brand d-flex align-items-center gap-2" href="/">
            <!-- مكان شعار رئيسي -->
            <img src="{% static 'img/logo-primary.png' %}" alt="Logo" onerror="this.style.display='none'">
            <div class="d-flex flex-column lh-1">
              <strong>مكتب المحاماة</strong>
              <span class="brand-subtitle">تسيير الدعاوى والتنفيذ</span>
            </div>
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="mainNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="paramDropdown"
                     role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-gear ms-1"></i> الإعدادات
                  </a>
                  <ul class="dropdown-menu dropdown-menu-end text-end" aria-labelledby="paramDropdown">
                    <li><a class="dropdown-item" href="{% url 'cabinet:typedepense_list' %}">
                      <i class="bi bi-cash-coin ms-1 text-secondary"></i> أنواع المصاريف
                    </a></li>
                    <li><a class="dropdown-item" href="{% url 'cabinet:typerecette_list' %}">
                      <i class="bi bi-wallet2 ms-1 text-success"></i> أنواع المداخيل
                    </a></li>
                    <li><a class="dropdown-item" href="{% url 'cabinet:roleutilisateur_list' %}">
                      <i class="bi bi-person-badge ms-1 text-primary"></i> أدوار المستخدمين
                    </a></li>
                    <li><a class="dropdown-item" href="{% url 'cabinet:statuttache_list' %}">
                      <i class="bi bi-list-check ms-1 text-warning"></i> حالات المهام
                    </a></li>
                    <li><a class="dropdown-item" href="{% url 'cabinet:typealerte_list' %}">
                      <i class="bi bi-bell ms-1 text-danger"></i> أنواع التنبيهات
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-muted" href="#">
                      <i class="bi bi-gear-wide-connected ms-1"></i> إعدادات أخرى (لاحقًا)
                    </a></li>
                  </ul>
                </li>

                <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  القضايا
                </a>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="{% url 'cabinet:affaire_list' %}"><i class="bi bi-journal-text ms-1"></i> لائحة القضايا</a></li>
                  <li><a class="dropdown-item" href="{% url 'cabinet:affaire_create' %}"><i class="bi bi-plus-circle ms-1"></i> إضافة قضية</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="{% url 'cabinet:audience_list' %}"><i class="bi bi-calendar3 ms-1"></i> الجلسات</a></li>
                  <li><a class="dropdown-item" href="{% url 'cabinet:decision_list' %}"><i class="bi bi-hammer ms-1"></i> الأحكام</a></li>
                  <li><a class="dropdown-item" href="{% url 'cabinet:notification_list' %}"><i class="bi bi-envelope-paper ms-1"></i> التبليغات</a></li>
                </ul>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">المالية</a>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="{% url 'cabinet:depense_list' %}"><i class="bi bi-cash-coin ms-1"></i> المصاريف</a></li>
                  <li><a class="dropdown-item" href="{% url 'cabinet:recette_list' %}"><i class="bi bi-coin ms-1"></i> المداخيل</a></li>
                </ul>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">التنفيذ والطعن</a>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="{% url 'cabinet:execution_list' %}"><i class="bi bi-gear ms-1"></i> التنفيذ</a></li>
                  <li><a class="dropdown-item" href="{% url 'cabinet:voiederecours_list' %}"><i class="bi bi-arrow-90deg-left ms-1"></i> طرق الطعن</a></li>
                </ul>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">الأرشيف والمرجع</a>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="{% url 'cabinet:piecejointe_list' %}"><i class="bi bi-folder2-open ms-1"></i> المرفقات</a></li>
                  <li><a class="dropdown-item" href="{% url 'cabinet:juridiction_list' %}"><i class="bi bi-building ms-1"></i> المحاكم</a></li>
                  <li><a class="dropdown-item" href="{% url 'cabinet:avocat_list' %}"><i class="bi bi-person-vcard ms-1"></i> المحامون</a></li>
                </ul>
              </li>
            </ul>

            <ul class="navbar-nav mb-2 mb-lg-0">
              <li class="nav-item me-3 d-none d-lg-flex align-items-center">
                <!-- مكان شعار ثانوي (هيئة المحامين مثلاً) -->
                <img src="{% static 'img/logo-barreau.png' %}" alt="Barreau" style="height:28px" onerror="this.style.display='none'">
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                  <i class="bi bi-person-circle"></i> الحساب
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><span class="dropdown-item-text"><i class="bi bi-envelope-at ms-1"></i> {{ request.user.email }}</span></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="{% url 'cabinet:tache_list' %}"><i class="bi bi-check2-square ms-1"></i> مهامي</a></li>
                  <li><a class="dropdown-item" href="{% url 'cabinet:alerte_list' %}"><i class="bi bi-bell ms-1"></i> التنبيهات</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="/admin/"><i class="bi bi-speedometer2 ms-1"></i> إدارة النظام</a></li>
                    <li><a class="dropdown-item" href="{% url 'authui:logout' %}"><i class="bi bi-box-arrow-left ms-1"></i> خروج</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      {% endblock header %}

      <main class="container my-4">
        <!-- رسائل النظام -->
        {% if messages %}
          <div class="mb-3">
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <!-- رأس الصفحة (عنوان + فتات التنقل + أزرار سريعة) -->
        <div class="page-header mb-3">
          <div>
            <h1 class="h4 m-0">{% block page_title %}العنوان{% endblock %}</h1>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb small m-0">
                {% block breadcrumbs %}
                <li class="breadcrumb-item"><a href="/">الرئيسية</a></li>
                {% endblock %}
              </ol>
            </nav>
          </div>
          <div class="d-flex gap-2">
            {% block header_actions %}{% endblock %}
          </div>
        </div>

        {% block content %}{% endblock %}
      </main>

      {% block footer %}
      <footer class="app-footer mt-auto py-4">
        <div class="container">
          <div class="row g-4 align-items-start">
            <div class="col-12 col-md-4">
              <div class="d-flex align-items-center gap-2 mb-2">
                <img src="{% static 'img/logo-footer.png' %}" alt="Logo" style="height:32px" onerror="this.style.display='none'">
                <strong>مكتب المحاماة</strong>
              </div>
              <p class="mb-1 small">نساعدكم على تتبع ملفاتكم القضائية بكفاءة عالية.</p>
              <div class="small text-secondary">© جميع الحقوق محفوظة.</div>
            </div>
            <div class="col-12 col-md-4">
              <h6 class="mb-2">العناوين ووسائل الاتصال</h6>
              <!-- أماكن العنوان/الهاتف/البريد -->
              <ul class="list-unstyled small m-0">
                <li class="mb-1"><i class="bi bi-geo-alt ms-1"></i> العنوان: شارع …، المدينة …</li>
                <li class="mb-1"><i class="bi bi-telephone ms-1"></i> الهاتف: 05xx-xx-xx-xx</li>
                <li class="mb-1"><i class="bi bi-envelope ms-1"></i> البريد: contact@example.com</li>
                <li><i class="bi bi-clock ms-1"></i> المواعيد: 09:00–17:00 (الإثنين–الجمعة)</li>
              </ul>
            </div>
            <div class="col-12 col-md-4">
              <h6 class="mb-2">روابط سريعة</h6>
              <ul class="list-unstyled small m-0">
                <li class="mb-1"><a class="footer-link" href="{% url 'cabinet:affaire_list' %}"><i class="bi bi-journal-text ms-1"></i> القضايا</a></li>
                <li class="mb-1"><a class="footer-link" href="{% url 'cabinet:audience_list' %}"><i class="bi bi-calendar3 ms-1"></i> الجلسات</a></li>
                <li class="mb-1"><a class="footer-link" href="{% url 'cabinet:execution_list' %}"><i class="bi bi-gear ms-1"></i> التنفيذ</a></li>
                <li><a class="footer-link" href="{% url 'cabinet:alerte_list' %}"><i class="bi bi-bell ms-1"></i> التنبيهات</a></li>
              </ul>
            </div>
          </div>
        </div>
      </footer>
      {% endblock footer %}
    </div>
{% include '_partials/_toast_container.html' %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    {% block extra_js %}
     <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <div class="modal fade" id="mainModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">—</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="modalBody"></div>
        </div>
      </div>
    </div>
        <script>
    document.body.addEventListener('htmx:afterRequest', function (evt) {
      try {
        const xhr = evt.detail.xhr;
        const contentType = xhr.getResponseHeader('Content-Type') || '';
        if (contentType.includes('application/json')) {
          const data = JSON.parse(xhr.responseText);
          if (data.ok) {
            // success toast
            const msg = (data.html && (new DOMParser()).parseFromString(data.html, 'text/html').querySelector('#hx-success-payload')?.dataset.message) || 'تمت العملية بنجاح.';
            const el = document.querySelector('#toastBody');
            if (el) { el.textContent = msg; }
            const toastEl = document.querySelector('#liveToast');
            if (toastEl) new bootstrap.Toast(toastEl).show();
            // redirect or partial refresh
            if (data.redirect) {
              window.location.assign(data.redirect);
            } else if (data.refreshTarget && data.refreshUrl) {
              htmx.ajax('GET', data.refreshUrl, { target: data.refreshTarget, swap: 'outerHTML' });
            }
            // close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('mainModal'));
            if (modal) modal.hide();
          }
        }
      } catch (e) { /* ignore */ }
    });
  </script>

<script>
  document.body.addEventListener('htmx:afterRequest', function (evt) {
    try {
      const xhr = evt.detail.xhr;
      const type = (xhr.getResponseHeader('Content-Type')||'');
      if (type.includes('application/json')) {
        const data = JSON.parse(xhr.responseText||'{}');
        if (data.ok) {
          // Toast
          const payload = (data.html && (new DOMParser()).parseFromString(data.html,'text/html').querySelector('#hx-success-payload')) || null;
          const msg = payload?.dataset.message || 'تمت العملية بنجاح.';
          const tb = document.querySelector('#toastBody'); if (tb) tb.textContent = msg;
          const toastEl = document.querySelector('#liveToast'); if (toastEl) new bootstrap.Toast(toastEl).show();
          // تحديث جزء محدد أو إعادة توجيه
          if (data.redirect) {
            window.location.assign(data.redirect);
          } else if (data.refreshTarget && data.refreshUrl) {
            htmx.ajax('GET', data.refreshUrl, { target: data.refreshTarget, swap: 'outerHTML' });
          }
          // إغلاق المودال
          const modal = bootstrap.Modal.getInstance(document.getElementById('mainModal'));
          if (modal) modal.hide();
        }
      }
    } catch (e) {}
  });
</script>
        <script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  document.body.addEventListener('htmx:configRequest', function (evt) {
    const token = getCookie('csrftoken');
    if (token) evt.detail.headers['X-CSRFToken'] = token;
  });
</script>
        <script>
  // Si le middleware renvoie 401/redirect (AJAX/HTMX), on redirige vers /auth/login/
  document.body.addEventListener('htmx:beforeOnLoad', function (evt) {
    if (evt.detail.xhr && evt.detail.xhr.status === 401) {
      try {
        const data = JSON.parse(evt.detail.xhr.responseText || "{}");
        if (data.redirect) window.location.href = data.redirect;
      } catch (e) {}
    }
  });

  // Après réponse HTMX OK, on traite le JSON de succès (toast/refresh…)
  document.body.addEventListener('htmx:afterOnLoad', function (evt) {
    try {
      const json = JSON.parse(evt.detail.xhr.responseText || "{}");
      if (json && json.ok) {
        const msg = json.message || json.html || "تمت العملية.";
        // TODO: afficher ton toast ici si tu veux
        if (json.refreshTarget && json.refreshUrl) {
          htmx.ajax('GET', json.refreshUrl, { target: json.refreshTarget, swap: 'outerHTML' });
        }
        if (json.redirect) window.location.href = json.redirect;
      }
    } catch (e) {}
  });
</script>
        <script>
// Initialisation lors du chargement initial
document.addEventListener("DOMContentLoaded", function() {
  initSelect2(document);
});

// Réinitialisation automatique après tout échange HTMX
document.body.addEventListener('htmx:afterSwap', function(evt) {
  initSelect2(evt.target);
});

function initSelect2(context){
  $(context).find('select').each(function(){
    const $el = $(this);
    if ($el.data('select2')) return; // ← empêche double init
    $el.select2({
      theme:'bootstrap-5', dir:'rtl', width:'100%',
      allowClear:true, placeholder:$el.attr('placeholder')||'اختر...',
      closeOnSelect: !$el.prop('multiple'),
      language:{ noResults:()=>"لا توجد نتائج", searching:()=>"جاري البحث..." }
    });
  });
}
document.addEventListener('DOMContentLoaded', ()=> initSelect2(document));
document.body.addEventListener('htmx:afterSwap', (e)=> initSelect2(e.target));

</script>



    {% endblock %}
  <!-- jQuery (nécessaire pour Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>

  </body>
</html>
{# ============================================================= #}
