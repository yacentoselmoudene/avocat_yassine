{# FILE: templates/avocat/affaire_list.html #}
{% extends 'base.html' %}
{% load form_extras %}
{% block title %}القضايا{% endblock %}
{% block page_title %}القضايا{% endblock %}

{% block breadcrumbs %}
  <li class="breadcrumb-item"><a href="/">الرئيسية</a></li>
  <li class="breadcrumb-item active">القضايا</li>
{% endblock %}

{% block header_actions %}
  <div class="input-group me-2" style="max-width: 320px;">
    <input type="text" class="form-control" name="q" placeholder="بحث بالمرجع/الموضوع…" value="{{ query }}"
           onkeydown="if(event.key==='Enter'){window.location='?q='+this.value+'&view={{ view_mode }}'}">
    <button class="btn btn-outline-secondary" onclick="window.location='?q='+this.previousElementSibling.value+'&view={{ view_mode }}'">
      <i class="bi bi-search"></i>
    </button>
  </div>
  <div class="btn-group me-2" role="group">
    <a class="btn btn-outline-secondary {% if view_mode == 'table' %}active{% endif %}" href="?view=table&q={{ query|urlencode }}"><i class="bi bi-table"></i></a>
    <a class="btn btn-outline-secondary {% if view_mode == 'cards' %}active{% endif %}" href="?view=cards&q={{ query|urlencode }}"><i class="bi bi-grid-3x3-gap"></i></a>
  </div>
  <a href="{% url 'cabinet:affaire_create' %}" class="btn btn-primary">
    <i class="bi bi-plus-circle ms-1"></i> إضافة قضية
  </a>
{% endblock %}

{% block content %}
  {% include '_partials/_filter_panel.html' %}

  {% if view_mode == 'cards' %}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3">
      {% for obj in object_list %}
      <div class="col">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h6 class="card-title mb-0 fw-bold">{{ obj.reference_interne }}</h6>
                <div class="text-secondary small mt-1"><i class="bi bi-building ms-1"></i> {{ obj.juridiction }}</div>
              </div>
              <span class="badge bg-primary-subtle text-primary-emphasis">{{ obj.type_affaire }}</span>
            </div>
            <div class="d-flex gap-2 mb-2">
              <span class="badge {% if obj.priorite == 'Haute' %}bg-danger{% elif obj.priorite == 'Basse' %}bg-success{% else %}bg-info{% endif %} bg-opacity-10 text-dark">
                {{ obj.get_priorite_display }}
              </span>
              <span class="badge bg-secondary-subtle text-secondary-emphasis">{{ obj.statut_affaire }}</span>
            </div>
            <dl class="row mt-2 mb-0 small">
              <dt class="col-5 text-secondary">المحامي</dt>
              <dd class="col-7">
                {% if obj.avocat_responsable %}
                <a href="#" class="person-link" data-bs-toggle="modal" data-bs-target="#mainModal"
                   hx-get="{% url 'cabinet:avocat_popup' obj.avocat_responsable.pk %}" hx-target="#modalBody">
                  {{ obj.avocat_responsable }}
                </a>
                {% else %}—{% endif %}
              </dd>
              <dt class="col-5 text-secondary">الفتح</dt><dd class="col-7">{{ obj.date_ouverture }}</dd>
              {% if obj.valeur_litige %}<dt class="col-5 text-secondary">القيمة</dt><dd class="col-7">{{ obj.valeur_litige }} د.م.</dd>{% endif %}
            </dl>
          </div>
          <div class="card-footer bg-transparent d-flex gap-2">
            <a class="btn btn-sm btn-outline-secondary flex-fill" href="{% url 'cabinet:affaire_detail' obj.pk %}"><i class="bi bi-eye"></i> عرض</a>
            <a class="btn btn-sm btn-primary flex-fill" href="#" data-bs-toggle="modal" data-bs-target="#mainModal"
               hx-get="{% url 'cabinet:affaire_update' obj.pk %}" hx-target="#modalBody"><i class="bi bi-pencil"></i> تعديل</a>
            <a class="btn btn-sm btn-outline-danger" href="#" data-bs-toggle="modal" data-bs-target="#mainModal"
               hx-get="{% url 'cabinet:affaire_delete' obj.pk %}" hx-target="#modalBody"><i class="bi bi-trash"></i></a>
          </div>
        </div>
      </div>
      {% empty %}{% include '_partials/_empty_state.html' %}{% endfor %}
    </div>
  {% else %}
    <div class="card shadow-sm border-0">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>المرجع</th>
              <th>النوع</th>
              <th>الحالة</th>
              <th>المحكمة</th>
              <th>المحامي</th>
              <th>الأولوية</th>
              <th>الفتح</th>
              <th class="text-center">إجراءات</th>
            </tr>
          </thead>
          <tbody>
          {% for obj in object_list %}
          <tr>
            <td class="fw-bold"><a href="{% url 'cabinet:affaire_detail' obj.pk %}" class="text-decoration-none">{{ obj.reference_interne }}</a></td>
            <td><span class="badge bg-primary-subtle text-primary-emphasis">{{ obj.type_affaire }}</span></td>
            <td><span class="badge bg-secondary-subtle text-secondary-emphasis">{{ obj.statut_affaire }}</span></td>
            <td class="small">{{ obj.juridiction }}</td>
            <td class="small">
              {% if obj.avocat_responsable %}
              <a href="#" class="person-link" data-bs-toggle="modal" data-bs-target="#mainModal"
                 hx-get="{% url 'cabinet:avocat_popup' obj.avocat_responsable.pk %}" hx-target="#modalBody">
                <i class="bi bi-briefcase-fill ms-1"></i> {{ obj.avocat_responsable }}
              </a>
              {% else %}—{% endif %}
            </td>
            <td>
              <span class="badge {% if obj.priorite == 'Haute' %}bg-danger{% elif obj.priorite == 'Basse' %}bg-success{% else %}bg-info{% endif %}">
                {{ obj.get_priorite_display }}
              </span>
            </td>
            <td class="small text-secondary">{{ obj.date_ouverture }}</td>
            <td class="text-center">
              <div class="btn-group btn-group-sm">
                <a class="btn btn-outline-secondary" href="{% url 'cabinet:affaire_detail' obj.pk %}" title="عرض"><i class="bi bi-eye"></i></a>
                <a class="btn btn-outline-primary" href="#" data-bs-toggle="modal" data-bs-target="#mainModal" hx-get="{% url 'cabinet:affaire_update' obj.pk %}" hx-target="#modalBody" title="تعديل"><i class="bi bi-pencil"></i></a>
                <a class="btn btn-outline-danger" href="#" data-bs-toggle="modal" data-bs-target="#mainModal" hx-get="{% url 'cabinet:affaire_delete' obj.pk %}" hx-target="#modalBody" title="حذف"><i class="bi bi-trash"></i></a>
              </div>
            </td>
          </tr>
          {% empty %}
            <tr><td colspan="8">{% include '_partials/_empty_state.html' %}</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {# Pagination #}
  {% if is_paginated %}
  <nav class="mt-3" aria-label="تنقل">
    <ul class="pagination pagination-sm justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?{% query_string page=page_obj.previous_page_number %}">السابق</a></li>
      {% endif %}
      {% for num in page_obj.paginator.page_range %}
        <li class="page-item {% if page_obj.number == num %}active{% endif %}">
          <a class="page-link" href="?{% query_string page=num %}">{{ num }}</a>
        </li>
      {% endfor %}
      {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?{% query_string page=page_obj.next_page_number %}">التالي</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
{% endblock %}
