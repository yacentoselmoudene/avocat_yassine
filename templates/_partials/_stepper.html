{# _partials/_stepper.html — Stepper CSS + JS réutilisable pour formulaires multi-étapes #}
<style>
  .stepper-nav {
    display: flex; gap: 0; margin-bottom: 1.5rem;
    border-bottom: 2px solid #e9ecef; padding-bottom: 0;
  }
  .stepper-nav .step-indicator {
    flex: 1; text-align: center; padding: .5rem .25rem;
    cursor: pointer; position: relative; font-size: .8rem;
    color: #6c757d; transition: all .2s;
  }
  .stepper-nav .step-indicator::after {
    content: ''; position: absolute; bottom: -2px; left: 0; right: 0;
    height: 3px; background: transparent; transition: background .2s;
  }
  .stepper-nav .step-indicator.active { color: var(--bs-primary, #0d6efd); font-weight: 600; }
  .stepper-nav .step-indicator.active::after { background: var(--bs-primary, #0d6efd); }
  .stepper-nav .step-indicator.completed { color: var(--bs-success, #198754); }
  .stepper-nav .step-indicator.completed::after { background: var(--bs-success, #198754); }
  .stepper-nav .step-indicator .step-num {
    display: inline-flex; align-items: center; justify-content: center;
    width: 22px; height: 22px; border-radius: 50%;
    background: #e9ecef; color: #6c757d; font-size: .7rem; font-weight: 700;
    margin-left: .3rem; transition: all .2s;
  }
  .stepper-nav .step-indicator.active .step-num { background: var(--bs-primary, #0d6efd); color: #fff; }
  .stepper-nav .step-indicator.completed .step-num { background: var(--bs-success, #198754); color: #fff; }
  .step-panel { display: none; }
  .step-panel.active { display: block; }
  .stepper-buttons { display: flex; justify-content: space-between; align-items: center; padding-top: .75rem; border-top: 1px solid #e9ecef; }
</style>

<script>
function initStepper(formEl) {
  var panels = formEl.querySelectorAll('[data-step]');
  var indicators = formEl.querySelectorAll('.step-indicator');
  var current = 0;
  var total = panels.length;

  function showStep(n) {
    panels.forEach(function(p, i) {
      p.classList.toggle('active', i === n);
    });
    indicators.forEach(function(ind, i) {
      ind.classList.remove('active');
      if (i < n) ind.classList.add('completed');
      else ind.classList.remove('completed');
      if (i === n) ind.classList.add('active');
    });
    current = n;
    // Toggle button visibility
    var prevBtn = formEl.querySelector('.stepper-prev');
    var nextBtn = formEl.querySelector('.stepper-next');
    var submitBtn = formEl.querySelector('.stepper-submit');
    if (prevBtn) prevBtn.style.display = (n === 0) ? 'none' : '';
    if (nextBtn) nextBtn.style.display = (n === total - 1) ? 'none' : '';
    if (submitBtn) submitBtn.style.display = (n === total - 1) ? '' : 'none';
  }

  function validateStep(n) {
    var panel = panels[n];
    var ok = true;
    panel.querySelectorAll('input[required], select[required], textarea[required]').forEach(function(inp) {
      if (!inp.value || inp.value.trim() === '') {
        inp.classList.add('is-invalid');
        ok = false;
      } else {
        inp.classList.remove('is-invalid');
      }
    });
    return ok;
  }

  // Attach navigation
  var prevBtn = formEl.querySelector('.stepper-prev');
  var nextBtn = formEl.querySelector('.stepper-next');
  if (nextBtn) {
    nextBtn.addEventListener('click', function(e) {
      e.preventDefault();
      if (validateStep(current) && current < total - 1) showStep(current + 1);
    });
  }
  if (prevBtn) {
    prevBtn.addEventListener('click', function(e) {
      e.preventDefault();
      if (current > 0) showStep(current - 1);
    });
  }

  // Click on step indicator
  indicators.forEach(function(ind, i) {
    ind.addEventListener('click', function() {
      // Allow going back freely, going forward requires validation
      if (i < current) { showStep(i); }
      else if (i > current) {
        // Validate all steps up to i
        var canGo = true;
        for (var j = current; j < i; j++) {
          if (!validateStep(j)) { canGo = false; showStep(j); break; }
        }
        if (canGo) showStep(i);
      }
    });
  });

  showStep(0);
}
</script>
